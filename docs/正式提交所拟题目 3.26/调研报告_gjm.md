# 调研报告

[TOC]

## 项目概述

在往届分布式文件系统项目的基础上，利用eBPF提高用户态与内核态之间数据交互的IO性能。

## 项目背景

往届项目中，dontpanic实现了可用性高的基于互联网网页的小型分布式文件系统，DiaGraphs利用图结构和图数据库管理的方式实现了一个对用户友好的、高可扩展性的分布式图文件系统，WowKiddy在 DisGraFS 的基础上完善了分布式文件系统的缓存机制，在索引和写入读取上进行优化，TOBEDONE在 DisGraFS 的基础上安装了监控系统，实现对计算节点和存储节点之间通信的实时监控。

### 可通过互联网访问、通过容器部署的分布式文件系统

分布式文件系统（Distributed File System）管理的物理存储资源不直接连接在本地节点上，而是通过计算机网络与离散分布的不同节点相连。分布式文件系统的设计同样基于Client/Server模式：一个典型的网络可以包括多个供用户访问的服务器，也允许存在同时扮演客户机和服务器的双重角色，用户可以公开一个允许其他客户机访问的公共目录，而且访问这个目录对其他客户机来说就像使用本地驱动器一样方便。

容器（Container）是极轻量级的操作系统虚拟化，它封装了所有运行应用程序所必需的相关细节比如应用依赖以及操作系统，这些组件被打包成一个镜像（Images）并可以在不同环境下复用。容器之间的进程是相互隔离的，其中一个容器的升级或者变化不会影响其他容器。由此可见，容器具有高可移植性、高兼容性和高可扩展性。

VPN就是通过密钥交换、封装、认证、加密手段在公共网络上建立起私密数据传输通道，同时保障传输数据的完整性、私密性和有效性的一种技术。传统SSL VPN根据应用协议的类型做相应的端口代理，在client和server之间建立SSL安全连接，但这种实现方式搭建繁琐、普适度低。 OpenVPN对其进行升级优化，使之在利用SSL来保证网络通讯安全性的同时，避免了传统SSL VPN仅提供简单的部分网络应用的不足，具有支持多协议、多平台的特点。

- 客户端采用容器化技术封装，部署便捷；
- 采用Java实现跨平台；
- 采用网页浏览器实现文件访问，方便灵活；
- 采用纠删码在节约存储空间的同时提高了系统容错性；
- 提供多用户权限使用方式，扩展存储空间的同时方便文件共享；
- 对文件先加密后存储，提高文件安全性；
- 通过设备历史在线状态的统计，优化上传文件时分配碎片的策略，提高服务可用性。

### 利用图结构特性优化分布式文件系统的存取结构

图数据库是一个使用图结构对数据进行存储和管理的非关系型数据库，它使用节点、边和属性来表示和存储数据。其最大特点有3个：高维、高性能、高效率。相比于传统的关系型数据库中的关系表（二维表），图数据库采用的是可描述复杂关联关系的高维拓扑结构，在十亿级别的数据量时，仍能保持较好的性能。图数据库可以高效进行关联查询、数据插入，并且提供了针对图查询的语言。

- 不依赖于用户对文件进行的自命名和归类，其查询关键词仅仅取决于文件的内容，非常适用于多用户情境。
- 文件/数据库的维护、关键词提取、查询过程中的计算等任务可以不再集中于一台机器，实现算力、存储和网络资源的合理的分配。
- 客户端无需在本地安装任何软件即可通过网页访问系统，服务端不依赖于特定平台，高可扩展性可以使更多边缘资源易于整合入系统，也确保了系统对各种平台用户的可用性。

### 完善分布式文件系统的缓存机制

对一个由对象存储和数据库组合驱动的文件系统来说，缓存指的是本地客户端与远端服务器之间的高效交互。读写的数据可以提前或者异步载入缓存，再由客户端在后台执行异步上传或预取数据。相比直接与远端服务交互，采用缓存技术可以大大降低存取操作的延时并提高数据吞吐量。

利用Hash提高增删改查效率（可考虑B+树、LSM树其他数据结构），主要思想是：
1.内存中采用基于哈希表的索引结构，即hash表存放的是数据在磁盘上的位置索引，磁盘上存放的是主键和value的实际内容。
2.定期合并，定期将旧的数据或者删除操作进行合并，保留最新的数据。
3.掉电恢复，在磁盘上保留一份索引记录，在定期合并的时候产生这份索引记录，当磁盘掉电的时候直接通过这个索引记录到内存中重建即可。

- 根据文件的自然属性，利用相同标签的block作为用户的缓存，减少相邻相似访存操作的网络延时，有效提升访存命中率。
- 当同一类标签中的文件内容集合过大时，抽象一个服务器节点作为虚拟缓存，提高访存速度的同时减少对本机网络带宽的占用。
- 支持文件预览，减少不符需求的实际访存操作次数。
- 将计算节点和存储节点分离

### 完善分布式文件系统的监控环境

Prometheus监控系统与InfluxDB开源时序型数据库相结合，负责管理及存储属于同一指标名称，同一标签集合的、有时间戳标记的数据流。OpenResty中可以使用 Lua 脚本语言调动NGNIX支持的各种C以及Lua模块，可以快速构造出足以胜任 10K 以上并发连接响应的超高性能 Web 应用系统。Grafana是一个可视化度量分析工具，可以将用户态与内核态之间的数据通信实时监控情况通过用户友好的图形化界面进行展示，并伴随完善的数据分析功能。

### XDP及其升级XRP

iptables/netfilter原是上个时代Linux网络提供的优秀防火墙技术，扩展性强，能够满足当时大部分网络应用需求。其通过与Linux内核网络协议栈内有包过滤功能的hook交互来完成工作，这些内核hook构成了netfilter框架。每个进入网络系统的包（接收或发送）在经过协议栈时都会触发这些hook，程序可以通过注册hook函数的方式在一些关键路径上处理网络流量。

随着互联网流量越来越大, 网卡性能越来越强，Linux内核协议栈在10Mbps/100Mbps网卡的慢速时代是没有任何问题的，但现在到了1000Mbps/10Gbps/40Gbps网卡的时代，数据被更快地收入，此时与内核协议栈有关的网络流量处理逻辑便显得复杂且效率低下。XDP让灌入网卡的eBPF程序直接处理网络流，bypass掉内核，使用网卡NPU专门干这个事。

XDP总体设计包括以下几个部分：

- XDP驱动：即网卡中XDP程序的一个挂载点，每当网卡接收到一个数据包就会执行这个XDP程序。XDP程序可以对数据包进行逐层解析、按规则进行过滤，或者对数据包进行封装或者解封装，修改字段对数据包进行转发等。
- BPF虚拟机：一个XDP程序首先是由用户用受限制的C语言编写的，然后通过clang前端编译生成BPF字节码，字节码加载到内核之后运行在eBPF虚拟机上，虚拟机通过JIT编译将XDP字节码编译成底层二进制指令。eBPF虚拟机支持XDP程序的动态加载和卸载。
- BPF映射：存储键值对，作为用户态程序和内核态XDP程序之间的通信媒介，类似于进程间通信的共享内存访问。用户态程序可以在BPF映射中预定义规则，XDP程序匹配映射中的规则对数据包进行过滤等操作；XDP程序将数据包统计信息存入BPF映射，用户态程序可访问BPF映射获取数据包统计信息。
- BPF程序校验器：确保XDP程序加载到内核之后不会导致内核崩溃或者带来其他的安全问题。程序校验器就是在将XDP字节码加载到内核之前对字节码进行安全检查。

XRP 的全称是 eXpress Resubmission Path(快速重提交路径)。与 SPDK 完全绕开内核存储栈，采⽤polling的⽅式来访问存储的⽅式不同，XRP 则是借鉴XDP的实现思路，将中间请求直接在 NVMe 驱动层进⾏重提交，从⽽避免让中间请求通过冗⻓的存储栈后再提交，达到加速的⽬的。在使⽤ XRP 的存储访问⽅式中，只有第⼀次请求和最后⼀次响应会经过⼀个完整的存储栈路径。显然，在允许范围内，B+ tree的树⾼越⾼，XRP 的加速效果也就越明显。

在实现NVMe驱动层重提交请求方面，XRP 引⼊了⼀种新的 BPF 类型(BPF_PROG_TYPE_XRP)，包含了 5 个字段，分别是

- char* data：⼀个缓冲区，⽤于缓冲从磁盘中读取出来的数据
- int done：布尔语意，表示 resubmission 逻辑是否应当返回给 user，还是应当继续 resubmitting I/O 请求
- uint64_t next_addr：逻辑地址数组，存放的是下次 resubmission 的逻辑地址
- uint64_t size：存放的是下次 resubmission 的请求的⼤⼩
- char* scratch：user 和 BPF 函数的私有空间，⽤来传递从 user 到 BPF 函数的参数。BPF 函数也可以⽤这段空间来保存中间数据。

在链式读请求方面，XRP分别继承了 BPF-KV（⼀个简易的基于 B+ Tree的键值存储引擎）和 WIREDTIGER（mongoDB 的后端键值存储引擎）的优势。

## 立项依据

前人之工作备矣，然当今大数据时代对文件的访存需求急剧增加，高性能存储设备虽已层出不穷，但数据交互速度提升的瓶颈在于用户态与内核态之间IO的繁琐协议栈。通过某些方法绕开内核（Bypass Kernel）从而简短数据传输的路径是自然能想到的办法。与此同时，eBPF技术的横空问世使得在不危及内核安全的前提下，加速内核对数据包的处理流程成为可能。

## 前瞻性/重要性分析

分布式文件系统是当前数据爆炸时代文件系统的主流方式，但目前DFS的优异性能还没有被完全开发、普通个体更无法接触到许多优质可用的DFS，为此ustc的osh项目组历经多年努力，一脉相承优化，终于使一个优质的分布式文件系统初见雏形。然而在使用DFS时，用户希望上传下载速度再快点再快点的朴素需求还并没有得到很好的满足。基于此，我们利用时兴的eBPF技术对linux内核态与用户态之间的数据通信进行速度上的提升优化，以期在保证内核安全的同时极大地提升效率，将是对分布式文件系统及内核性能的再一次深度挖掘开发。

## 相关工作

<https://github.com/OSH-2021/x-DisGraFS>
<https://github.com/OSH-2022/x-WowKiddy>
<https://github.com/OSH-2022/x-TOBEDONE>
<https://github.com/OSH-2020/x-dontpanic>
<https://cloud.tencent.com/developer/article/1706635>
<https://zhuanlan.zhihu.com/p/69374970>
<https://juicefs.com/docs/zh/community/cache_management/>
<https://tech.ipalfish.com/blog/2020/07/21/tidb_monitor/>
<https://zhuanlan.zhihu.com/p/558509760?utm_id=0>
<https://istio.io/latest/zh/blog/2022/merbridge/>
<https://heapdump.cn/article/4385115?>
