[TOC]

# TagServer 部署（Ubuntu20.04环境）

![](打标服务器部署_gjm.assets/wowkiddy_structure.png)

## 1. JuiceFS配置

### 1.1 Juicefs安装

```shell
JFS_LATEST_TAG=$(curl -s https://api.github.com/repos/juicedata/juicefs/releases/latest | grep 'tag_name' | cut -d '"' -f 4 | tr -d 'v')
wget "https://github.com/juicedata/juicefs/releases/download/v${JFS_LATEST_TAG}/juicefs-${JFS_LATEST_TAG}-linux-amd64.tar.gz"
tar -zxf "juicefs-${JFS_LATEST_TAG}-linux-amd64.tar.gz"
sudo install juicefs /usr/local/bin
```

依次执行上述四条命令后，在终端输入`juicefs`，若返回相关帮助信息，则juicefs安装完成。
![](打标服务器部署_gjm.assets/juicefsinstall.png)

### 1.2 文件系统创建及挂载

可参考官方文档：<https://juicefs.com/docs/zh/community/getting-started/for_distributed>
所需预置部件：云存储容器与云数据库（本项目借助阿里云服务）

#### 1.2.1 创建文件系统

```shell
juicefs format \
    --storage oss \
    --bucket https://disgrafs-prime.oss-cn-hangzhou.aliyuncs.com \
    --access-key LTAI5tFaASmziEAoKWR6u4ec \
    --secret-key sRqGYW8Zwnz5haa66tdmaaZauj0r0U \
    redis://yiran:yiran_123@disgrafs.redis.rds.aliyuncs.com:6379/1 \
    myjfs
```

注意输入时的空格分割，storage指定对象存储介质类型， bucket指定具体云存储容器， redis即所使用的的云数据库， myjfs为创建的文件系统。

创建过程中可能遇到的问题：根据报错信息需要修改redis中的maxmemory_policy参数，bucket的名称需要根据自己申请的oss修改。
![](打标服务器部署_gjm.assets/juicefsformat_bug.png)
![](打标服务器部署_gjm.assets/jfsformat_debug1.png)
![](打标服务器部署_gjm.assets/jfsformat_debug2.png)
文件系统创建成功界面如下图所示：
![](打标服务器部署_gjm.assets/jfsformat.png)

#### 1.2.2 挂载文件系统

` juicefs mount redis://yiran:yiran_123@disgrafs.redis.rds.aliyuncs.com:6379/1 ~/jfs -d `
该命令中`~/jfs`指定了本地挂载目录的路径（可根据需要自行更替）， 挂载成功后当前终端页面成为juicefs的管理日志区在前台运行，可根据需要使用`-d` 表示将程序放入后台运行，若想更改挂载路径，只需使用`juicefs umount ~/jfs`即可卸载已挂载的文件目录。
成功挂载界面如下：
![](打标服务器部署_gjm.assets/jfsmount.png)
若未知某一文件目录是否已挂载，可以通过`juicefs bench + 目录路径`命令测试是否挂载及当前目录的读写性能。juicefs读写处理逻辑可参考官方文档：<https://juicefs.com/docs/zh/community/internals/io_processing>
![](打标服务器部署_gjm.assets/jfsbench.png)

## 2. Ray配置（以下适配python3版本）

### 2.1 Ray安装

如已支持pip命令则跳过此步，否则按如下安装pip：

```shell
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
sudo python3 get-pip.py
```

更新后安装rag最新发行版

```shell
sudo apt update
pip install -U ray
pip install 'ray[default]' #美化cli界面
```

### 2.2 节点配置及启动

结点集群搭建需要创建head结点：

```shell
ray start --head --port=6379
```

此后如果要退出集群，只需运行：

```shell
ray stop
```

若上次运行忘记退出集群，此时再次启动头结点会报错结点已在启动中，请先使用如下命令重新启动：

```
sudo service redis stop
ray start --head --port=6379
```

成功启动ray的head结点界面如下：
![](打标服务器部署_gjm.assets/raystartup.png)

## 3. 相关程序依赖库引入

```shell
pip install pdfplumber
pip install sphinx
pip install ffmpeg
pip install SpeechRecognition
pip install tinytag
pip install pydub
python3 -m nltk.downloader stopwords
python3 -m nltk.downloader universal_tagset
pip install spacy
python3 -m spacy download en_core_web_sm
pip install git+https://github.com/boudinfl/pke.git #此步需要先在服务器上安装git相关依赖且能科学上网connect到github上
```

在安装时可能遇到的问题：

显示找不到模块`nltk`，需要先安装python中的nltk库：
![](打标服务器部署_gjm.assets/nltkinstall1.png)
安装成功后以下命令不会出现报错：
![](打标服务器部署_gjm.assets/nltkimport.png)

```shell
python3 -m nltk.downloader stopwords
python3 -m nltk.downloader universal_tagset
```

这两个安装语句在安装时可能会遇到问题，报错信息如下：
![](打标服务器部署_gjm.assets/nltk_bug.png)

需要将图中所示下载路径`/root/nltk_data`文件夹中所有文件转移至图中显示的nltk安装路径：`/usr/local/lib/python3.8/dist-packages/nltk`

其余可能在下载过程中遇到网络不稳定等问题，可以多次尝试：

![](打标服务器部署_gjm.assets/spacyimport.png)

![](打标服务器部署_gjm.assets/pkeinstall.png)

## 4. Tagserver中python文件需要修改的部分

### 4.1 tag_server.py

更改所连接的main server域名及端口：

```python
wsClient = await websockets.connect('ws://47.119.121.73:9090')
```

### 4.2 tagging.py

更改juicefs文件系统挂载在打标服务器上的具体路径，最后一定要加上/，建并议在打标服务器上挂载时，挂载路径使用全小写。

```python
filePath = "/root/jfs/" + filePath
```

## 5. Prometheus配置

（详情参见Wowkiddy项目组package目录下的TagServer部署文档）

预准备：安装相关依赖，挂载juicefs，启动ray集群，并将tagging.py中路径设置为juicefs挂载的路径

解压prometheus.tar.gz，进入目录下

将prometheus.yml文件内容作如下替换：

``` yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

rule_files:

  # - "first_rules.yml"

  # - "second_rules.yml"

scrape_configs:

  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "juicefs"
    static_configs:
      - targets: ["localhost:9567"]
```

然后使用如下命令启动prometheus：

```shell
./prometheus --config.file=prometheus.yml
```

若遇到权限问题，可使用`chmod`命令授权
![](打标服务器部署_gjm.assets/prometheus_bug.png)
若遇到端口已被使用无法bind，可使用`fuser -n tcp -k -9 <端口号>`强制结束进程
![](打标服务器部署_gjm.assets/prometheus_kill.png)
正确启动prometheus界面如下：
![](打标服务器部署_gjm.assets/prometheus.png)

## 6. Grafana配置

安装Grafana：

```shell
sudo apt-get install -y wget
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
```

```shell
echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list
```

```shell
sudo apt-get update
sudo apt-get install grafana
```

启动Grafana：

```shell
sudo systemctl daemon-reload
sudo systemctl start grafana-server
sudo systemctl status grafana-server
```

![](打标服务器部署_gjm.assets/grafana.png)

整体项目运行起来后应可以在<http://localhost:3000>看到Grafana监控可视化数据图表

## 7. TagServer连接

在启动mainserver后使用`python3 tag_server.py`即可
![](打标服务器部署_gjm.assets/tagserver_connected.png)
