# WHAT

## 什么是eBPF

### 概念

eBPF是一种可编程的内核技术，可以在不修改内核源代码的情况下，动态地改变内核的行为。eBPF的全称是扩展的Berkeley Packet Filter，最初是用于网络数据包过滤和分析的。现在，eBPF已经发展成为一种通用的内核执行引擎，可以在内核中运行用户定义的程序，实现各种功能，如性能监控、安全审计、故障排除、跟踪分析等。eBPF的优点是它可以提供高效、灵活、安全的内核编程能力，而不需要重新编译或重启内核。



Linux 内核的主要目的是抽象硬件或虚拟硬件，并提供一致的 API（系统调用），允许应用程序运行和共享资源。为了实现这一目标，需要维护一组广泛的子系统和层来分配这些职责。每个子系统通常允许进行某种级别的配置，以满足用户的不同需求。如果无法配置所需的行为，则需要更改内核，如果没有eBPF，那么有以下两种选项：

- 等待Linux内核社区更新
- 编写内核模块并定期修复

使用 eBPF，可以使用一个新选项，允许重新编程 Linux 内核的行为，而无需更改内核源代码或加载内核模块。

### HOOK

eBPF 程序是事件驱动的，在内核或应用程序通过某个钩点时运行。预定义的钩子包括系统调用、函数进入/退出、内核跟踪点、网络事件等。

如果不存在满足特定需求的预定义钩子，则可以创建内核探测（kprobe）或用户探测（uprobe）来附加内核或用户应用程序中几乎任何位置的eBPF程序。

### maps

`BPF Map`用于用户空间和内核空间之间的数据交换、信息传递。

`BPF Map`是驻留在内核中的以键/值方式存储的数据结构，可以被任何知道它们的BPF程序访问。在用户空间运行的程序可以通过使用文件描述符来访问`BPF Map`。可以在`BPF Map`中存储任何类型的数据，只要事先正确指定数据大小。在内核中，键和值都被视为二进制的方式来存储。

### 共享内存

共享内存是指多个进程可以访问同一块物理内存，使得它们可以直接地共享数据而不需要进行数据的拷贝。在基于eBPF实现共享内存的过程中，我们可以利用eBPF提供的map数据结构，将内核态和用户态之间共享的数据存储在map中。进程可以通过eBPF提供的系统调用访问这些map，从而实现共享内存。

#### 优点：

1. 共享内存可以避免数据的拷贝，提高数据传输的性能。
2. 可以方便地实现多个进程之间的数据共享，简化程序设计。
3. 具有高效的数据传输和共享方式，提高了程序的执行效率。

#### 缺点：

1. 共享内存需要进程间的协调和同步，否则会导致数据的一致性问题。
2. 共享内存的空间有限，需要进行管理和分配。
3. 共享内存存在内存泄漏和死锁的风险，需要特殊的设计和处理。

### 工作原理

1. BPF Program 通过 LLVM/Clang 编译成 eBPF 定义的字节码 prog.bpf
2. 通过系统调用 bpf() 将 bpf 字节码指令传入内核中
3. 经过 verifier 检验字节码的安全性、合规性
4. 在确认字节码安全后将其加载对应的内核模块执行，通过 Helper/hook 机制，eBPF 与内核可以交换数据/逻辑。BPF 观测技术相关的程序程序类型可能是kprobes/uprobes/tracepoint/perf_events 中的一个或多个，其中：
   - kprobes：实现内核中动态跟踪。 kprobes 可以跟踪到 Linux 内核中的函数入口或返回点，但是不是稳定 ABI 接口，可能会因为内核版本变化导致跟踪失效。理论上可以跟踪到所有导出的符号 /proc/kallsyms 。
   - uprobes：用户级别的动态跟踪。与 kprobes 类似，只是跟踪的函数为用户程序中的函数。
   - tracepoints：内核中静态跟踪。tracepoints 是内核开发人员维护的跟踪点，能够提供稳定的 ABI 接口，但是由于是研发人员维护，数量和场景可能受限。
   - perf_events：定时采样和 PMC 。

5. 用户空间通过 BPF map 与内核通信。

## 分布式文件系统

分布式文件系统（Distributed File System）管理的物理存储资源不直接连接在本地节点上，而是通过计算机网络与离散分布的不同节点相连。分布式文件系统的设计同样基于Client/Server模式：一个典型的网络可以包括多个供用户访问的服务器，也允许存在同时扮演客户机和服务器的双重角色，用户可以公开一个允许其他客户机访问的公共目录，而且访问这个目录对其他客户机来说就像使用本地驱动器一样方便。

### 必要性

1. 目前各大商业网盘传输速度受限、空间收费等特点不能很好地满足我们对存储的需求。

2. 分布式的意义：

   - 解决大规模运算，存储，管理中，单个计算机算力不足，存储空间不足，连接过慢，负载过高的问题

   - 将数据存储在多个节点上，可以调高数据的可靠性和可用性

### 相关名词

- JIT 即时编译技术
- VFS 虚拟文件系统
- TCP/IP 用于因特网的通信协议