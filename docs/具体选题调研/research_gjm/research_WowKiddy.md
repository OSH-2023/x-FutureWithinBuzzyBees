# 项目概览

> 在 DisGraFS 上完善分布式文件系统的缓存机制，在索引和写入读取上进行优化。

## 简言分布式文件系统的性能期望（可头脑风暴补充）

- 符合 POSIX 文件接口标准，同时对用户的遗留系统也无需改造；
- 对用户透明，能够像使用本地文件系统那样直接使用；
- 持久化保存，保证数据不会丢失；
- 具有伸缩性，当数据压力逐渐增长时能顺利扩容；
- 具有可靠的安全机制，保证数据安全；
- 保证数据一致性；
- 提供的存储空间越大越好；
- 提供的边缘资源越多越好；
- 支持的并发访问请求越多越好；
- 上传下载的性能越快越好；
- 对硬件资源的利用率越高越合理越好。

## 日志记录提高分布式文件系统的数据一致性

日志文件系统（Journaling file system），在文件系统内部发生变化时，先把相关操作信息写入日志，然后再对主文件系统执行相应操作。这么做的意义是当对文件系统进行修改的操作被中途打断时，可通过读取日志重新执行未完成的操作，从而保证数据的一致性。
APFS：（apple）。采用日志机制来增改文件，进行数据的删改时，先编写日志记录，然后将指针指向新记录，释放旧记录，这样就避免了存储损坏记录。

Paxos算法是Lamport提出的一种基于消息传递的分布式一致性算法，PhxPaxos是腾讯公司微信后台团队自主研发的一套基于Paxos协议的多机状态拷贝类库。它以库函数的方式嵌入到开发者的代码当中，使得一些单机状态服务可以扩展到多机器，从而获得强一致性的多副本以及自动容灾的特性。

## 缓存机制提高文件系统的读写性能

参考原文：<https://juicefs.com/docs/zh/community/cache_management/>
对一个由对象存储和数据库组合驱动的文件系统来说，缓存指的是本地客户端与远端服务器之间的高效交互。读写的数据可以提前或者异步载入缓存，再由客户端在后台执行异步上传或预取数据。相比直接与远端服务交互，采用缓存技术可以大大降低存取操作的延时并提高数据吞吐量。

## 利用Hash提高增删改查效率（可考虑B+树、LSM树其他数据结构）

基于哈希表结构的键值存储系统，支持随机的数据增删改查，但仅支持追加写操作，同一时刻只有一个活跃的新文件，读写的时间复杂度O(1)。
主要思想是：
1.内存中采用基于哈希表的索引结构，即hash表存放的是数据在磁盘上的位置索引，磁盘上存放的是主键和value的实际内容。
2.定期合并，定期将旧的数据或者删除操作进行合并，保留最新的数据。
3.掉电恢复，在磁盘上保留一份索引记录，在定期合并的时候产生这份索引记录，当磁盘掉电的时候直接通过这个索引记录到内存中重建即可。

## 其他工作亮点

- 根据文件的自然属性，利用相同标签的block作为用户的缓存，减少相邻相似访存操作的网络延时，有效提升访存命中率。
- 当同一类标签中的文件内容集合过大时，抽象一个服务器节点作为虚拟缓存，提高访存速度的同时减少对本机网络带宽的占用。
- 支持文件预览，减少不符需求的实际访存操作次数。
- 将计算节点和存储节点分离

## 选择JuiceFS的理由

核心特性

- 丰富API接口：（API与SDK特性比较）
- POSIX 兼容：可像本地文件系统一样使用；
- HDFS 兼容：完整兼容 HDFS API，是大数据集群实现存储计算分离架构的理想存储选择；
- S3 兼容：提供 S3 Gateway 实现 S3 协议兼容的访问接口；
- 适用于云原生环境：便于在 Kubernetes 中搭建使用；
- 支持元数据缓存：便于保留数据的上下文信息，提高访存索引效率
- 多端共享：同一文件系统可在上千台服务器同时挂载，高性能并发读写，共享数据；
- 强一致性：确认的修改会在所有挂载了同一文件系统的服务器上立即可见，保证强一致性；
- 支持内核页缓存及内存回写：毫秒级的延迟，近乎无限的吞吐量（取决于对象存储规模）；
- 数据安全：支持传输中加密（encryption in transit）以及静态加密（encryption at rest）；
- 文件锁：支持 BSD 锁（flock）及 POSIX 锁（fcntl）；
- 数据压缩：支持使用 LZ4 或 Zstandard 压缩数据，节省存储空间；

## 选择Lua的理由

Lua，葡萄牙语“月亮”，是一个简洁、轻量、可扩展的嵌入式脚本语言，支持增量式垃圾收集策略。有内建的、与操作系统无关的协作式多线程支持。Lua原生支持的数据类型很少，但是其处理表和字符串的效率非常高，加上元表的支持，开发者可以高效的模拟出需要的复杂数据类型（比如集合、数组等）。
